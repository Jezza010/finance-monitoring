<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый мониторинг</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../static/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/img/favicon-16x16.png">
    <link rel="manifest" href="../static/img/site.webmanifest">

</head>
<body>

<div id="navbar"></div>
<div class="container mt-5">
<h2>Дашборды</h2>
    <br>

    <!-- Панель переключения дашбордов -->
    <div class="btn-group mb-4 w-100" role="group" id="dashboardButtons">
        <button type="button" class="btn btn-outline-primary active" data-frame="frame1">Количество транзакций</button>
        <button type="button" class="btn btn-outline-primary" data-frame="frame2">Тип транзакций</button>
        <button type="button" class="btn btn-outline-primary" data-frame="frame3">Поступления/Расходы</button>
        <button type="button" class="btn btn-outline-primary" data-frame="frame4">Статусы транзакций</button>
        <button type="button" class="btn btn-outline-primary" data-frame="frame5">Банки</button>
        <button type="button" class="btn btn-outline-primary" data-frame="frame6">Категории</button>
    </div>

    <!-- Дашборд 1 -->
    <div id="frame1" class="dashboard-frame active">
        <h3 class="text-center">Динамика по количеству транзакций</h3>
        <br>
        <button id="download-transaction-count" class="btn btn-primary">Скачать в PDF</button>
        <div class="d-flex justify-content-center mb-4">
            <button id="weekBtn" class="btn btn-outline-primary mx-2">Неделя</button>
            <button id="monthBtn" class="btn btn-outline-primary mx-2">Месяц</button>
            <button id="quarterBtn" class="btn btn-outline-primary mx-2">Квартал</button>
            <button id="yearBtn" class="btn btn-outline-primary mx-2">Год</button>
        </div>
        <canvas id="transactionChart"></canvas>
    </div>

    <!-- Дашборд 2 -->
        <div id="frame2" class="dashboard-frame">
            <h2 class="text-center">Динамика по типу транзакции</h2>
            <br>
            <button id="download-debit-credit" class="btn btn-primary">Скачать в PDF</button>
            <div class="d-flex justify-content-center mb-4">
                <button id="type-weekBtn" class="btn btn-outline-primary mx-2">Неделя</button>
                <button id="type-monthBtn" class="btn btn-outline-primary mx-2 active">Месяц</button>
                <button id="type-quarterBtn" class="btn btn-outline-primary mx-2">Квартал</button>
                <button id="type-yearBtn" class="btn btn-outline-primary mx-2">Год</button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-center">Дебет (Списания)</h5>
                    <canvas id="debitChart"></canvas>
                </div>
                <div class="col-md-6">
                    <h5 class="text-center">Кредит (Поступления)</h5>
                    <canvas id="creditChart"></canvas>
                </div>
            </div>
        </div>

    <!-- Дашборд 3 -->
    <div id="frame3" class="dashboard-frame">
        <h3 class="text-center">Сравнение поступлений и расходов</h3>
        <br>
        <button id="download-income-expense" class="btn btn-primary">Скачать в PDF</button>
        <div class="row">
            <div class="col-md-6">
                <canvas id="incomeExpenseBarChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="incomeExpensePieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Дашборд 4 -->
    <div id="frame4" class="dashboard-frame">
        <h3 class="text-center">Статистика по статусам транзакций</h3>
        <br>
        <button id="download-status" class="btn btn-primary">Скачать в PDF</button>
        <canvas id="statusPieChart"></canvas>
    </div>

    <!-- Дашборд 5 -->
    <div id="frame5" class="dashboard-frame">
        <h3 class="text-center">Статистика по банкам</h3>
        <br>
        <button id="download-banks" class="btn btn-primary">Скачать в PDF</button>
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-center">Отправители</h5>
                <canvas id="senderBanksChart"></canvas>
            </div>
            <div class="col-md-6">
                <h5 class="text-center">Получатели</h5>
                <canvas id="receiverBanksChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Дашборд 6 -->
    <div id="frame6" class="dashboard-frame">
        <h3 class="text-center">Статистика по категориям</h3>
        <br>
        <button id="download-categories" class="btn btn-primary">Скачать в PDF</button>
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-center">Расходы</h5>
                <canvas id="expenseCategoriesChart"></canvas>
            </div>
            <div class="col-md-6">
                <h5 class="text-center">Поступления</h5>
                <canvas id="incomeCategoriesChart"></canvas>
            </div>
        </div>
    </div>


    <script>
    let isAuthenticated = false;

    document.addEventListener('DOMContentLoaded', function() {
        checkSessionAndInit();
    });

    async function checkSessionAndInit() {
        try {
            const response = await fetch('/api/auth/check', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
            });
            if (response.ok) {
                const data = await response.json();
                isAuthenticated = data.authenticated;
            } else {
                isAuthenticated = false;
            }
        } catch (e) {
            isAuthenticated = false;
        }

        if (isAuthenticated) {
            initializeCharts();
            initializeEventListeners();
            loadInitialData();
        } else {
            showNotAuthenticatedMessage();
        }
    }

    function showNotAuthenticatedMessage() {
        const container = document.querySelector('.container');
        if (container) {
            container.innerHTML = '<div class="alert alert-warning mt-5 text-center">Пожалуйста, войдите в систему для просмотра дашборда.</div>';
        }
    }

    function initializeCharts() {
        // Transaction count chart
        const transactionCtx = document.getElementById('transactionChart');
        if (transactionCtx) {
            window.transactionChart = new Chart(transactionCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество транзакций',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Период' } },
                        y: { title: { display: true, text: 'Количество' }, beginAtZero: true }
                    }
                }
            });
        }

        // Debit/Credit charts
        const debitCtx = document.getElementById('debitChart');
        const creditCtx = document.getElementById('creditChart');
        
        if (debitCtx) {
            window.debitChart = new Chart(debitCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Дебет',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Период' } },
                        y: { title: { display: true, text: 'Сумма' }, beginAtZero: true }
                    }
                }
            });
        }

        if (creditCtx) {
            window.creditChart = new Chart(creditCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Кредит',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Период' } },
                        y: { title: { display: true, text: 'Сумма' }, beginAtZero: true }
                    }
                }
            });
        }

        // Income/Expense charts
        const incomeExpenseBarCtx = document.getElementById('incomeExpenseBarChart');
        const incomeExpensePieCtx = document.getElementById('incomeExpensePieChart');
        
        if (incomeExpenseBarCtx) {
            window.incomeExpenseBarChart = new Chart(incomeExpenseBarCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Поступления', 'Расходы'],
                    datasets: [{
                        label: 'Сумма (₽)',
                        data: [0, 0],
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        if (incomeExpensePieCtx) {
            window.incomeExpensePieChart = new Chart(incomeExpensePieCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Поступления', 'Расходы'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 159, 64, 0.6)']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Status chart
        const statusCtx = document.getElementById('statusPieChart');
        if (statusCtx) {
            window.statusPieChart = new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Новая', 'Подтвержденная', 'В обработке', 'Платеж выполнен', 'Платеж удален', 'Возврат', 'Отменена'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 205, 86, 0.6)',
                            'rgba(201, 203, 207, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Banks charts
        const senderBanksCtx = document.getElementById('senderBanksChart');
        const receiverBanksCtx = document.getElementById('receiverBanksChart');
        
        if (senderBanksCtx) {
            window.senderBanksChart = new Chart(senderBanksCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество транзакций (Отправители)',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        if (receiverBanksCtx) {
            window.receiverBanksChart = new Chart(receiverBanksCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество транзакций (Получатели)',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Categories charts
        const expenseCategoriesCtx = document.getElementById('expenseCategoriesChart');
        const incomeCategoriesCtx = document.getElementById('incomeCategoriesChart');
        
        if (expenseCategoriesCtx) {
            window.expenseCategoriesChart = new Chart(expenseCategoriesCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Категории расходов',
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        if (incomeCategoriesCtx) {
            window.incomeCategoriesChart = new Chart(incomeCategoriesCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Категории поступлений',
                        data: [],
                        backgroundColor: [
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 205, 86, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
    }

    function initializeEventListeners() {
        // Period buttons
        const periodButtons = {
            'weekBtn': 'W',
            'monthBtn': 'M',
            'quarterBtn': 'Q',
            'yearBtn': 'Y'
        };

        Object.entries(periodButtons).forEach(([id, period]) => {
            const button = document.getElementById(id);
            if (button) {
                button.addEventListener('click', () => fetchTransactionData(period));
            }
        });

        // Type period buttons
        const typePeriodButtons = {
            'type-weekBtn': 'W',
            'type-monthBtn': 'M',
            'type-quarterBtn': 'Q',
            'type-yearBtn': 'Y'
        };

        Object.entries(typePeriodButtons).forEach(([id, period]) => {
            const button = document.getElementById(id);
            if (button) {
                button.addEventListener('click', () => fetchDebitCreditData(period));
            }
        });

        // Dashboard buttons
        const dashboardButtons = document.querySelectorAll('#dashboardButtons button');
        dashboardButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetFrameId = button.getAttribute('data-frame');
                if (targetFrameId) {
                    document.querySelectorAll('.dashboard-frame').forEach(frame => {
                        frame.classList.remove('active');
                    });
                    document.querySelectorAll('#dashboardButtons button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    const targetFrame = document.getElementById(targetFrameId);
                    if (targetFrame) {
                        targetFrame.classList.add('active');
                        button.classList.add('active');
                    }
                }
            });
        });
    }

    function loadInitialData() {
        fetchTransactionData('M');
        fetchDebitCreditData('M');
        fetchIncomeExpenseData();
        fetchStatusData();
        fetchBanksData();
        fetchCategoriesData();
    }

    // Chart update functions
    function updateIncomeExpenseCharts(data) {
        if (!data) return;
        
        const barChart = window.incomeExpenseBarChart;
        const pieChart = window.incomeExpensePieChart;
        
        if (barChart) {
            barChart.data.datasets[0].data = [data.income || 0, data.expense || 0];
            barChart.update();
        }
        
        if (pieChart) {
            pieChart.data.datasets[0].data = [data.income || 0, data.expense || 0];
            pieChart.update();
        }
    }

    function updateStatusChart(data) {
        if (!data) return;
        
        const chart = window.statusPieChart;
        if (chart) {
            chart.data.datasets[0].data = Object.values(data);
            chart.update();
        }
    }

    function updateBanksCharts(data) {
        if (!data) return;
        
        const senderChart = window.senderBanksChart;
        const receiverChart = window.receiverBanksChart;
        
        if (senderChart) {
            senderChart.data.labels = Object.keys(data.sender || {});
            senderChart.data.datasets[0].data = Object.values(data.sender || {});
            senderChart.update();
        }
        
        if (receiverChart) {
            receiverChart.data.labels = Object.keys(data.receiver || {});
            receiverChart.data.datasets[0].data = Object.values(data.receiver || {});
            receiverChart.update();
        }
    }

    function updateCategoriesCharts(data) {
        if (!data) return;
        
        const expenseChart = window.expenseCategoriesChart;
        const incomeChart = window.incomeCategoriesChart;
        
        if (expenseChart) {
            expenseChart.data.labels = Object.keys(data.expense || {});
            expenseChart.data.datasets[0].data = Object.values(data.expense || {});
            expenseChart.update();
        }
        
        if (incomeChart) {
            incomeChart.data.labels = Object.keys(data.income || {});
            incomeChart.data.datasets[0].data = Object.values(data.income || {});
            incomeChart.update();
        }
    }

    // Data fetching functions with error handling
    async function fetchTransactionData(period) {
        try {
            const response = await fetch(`/api/transactions_count?period=${period}`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            if (!data || !Array.isArray(data)) {
                throw new Error('Invalid data format received');
            }

            const chart = window.transactionChart;
            if (chart) {
                chart.data.labels = data.map(point => point.x);
                chart.data.datasets[0].data = data.map(point => point.y);
                chart.update();
            }
        } catch (error) {
            console.error('Error fetching transaction data:', error);
            showToast('Ошибка при загрузке данных о транзакциях', true);
        }
    }

    async function fetchDebitCreditData(period) {
        try {
            const response = await fetch(`/api/transactions/sum_by_type?period=${period}`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            if (!data || !Array.isArray(data)) {
                throw new Error('Invalid data format received');
            }

            const debitChart = window.debitChart;
            const creditChart = window.creditChart;

            if (debitChart) {
                debitChart.data.labels = data.map(point => point.x);
                debitChart.data.datasets[0].data = data.map(point => point.debit || 0);
                debitChart.update();
            }

            if (creditChart) {
                creditChart.data.labels = data.map(point => point.x);
                creditChart.data.datasets[0].data = data.map(point => point.credit || 0);
                creditChart.update();
            }
        } catch (error) {
            console.error('Error fetching debit/credit data:', error);
            showToast('Ошибка при загрузке данных о дебете/кредите', true);
        }
    }

    async function fetchIncomeExpenseData() {
        try {
            const response = await fetch('/api/transactions/income_expense', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            updateIncomeExpenseCharts(data);
        } catch (error) {
            console.error('Error fetching income/expense data:', error);
            showToast('Ошибка при загрузке данных о доходах/расходах', true);
        }
    }

    async function fetchStatusData() {
        try {
            const response = await fetch('/api/transactions/status_stats', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            updateStatusChart(data);
        } catch (error) {
            console.error('Error fetching status data:', error);
            showToast('Ошибка при загрузке данных о статусах', true);
        }
    }

    async function fetchBanksData() {
        try {
            const response = await fetch('/api/transactions/banks_stats', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            updateBanksCharts(data);
        } catch (error) {
            console.error('Error fetching banks data:', error);
            showToast('Ошибка при загрузке данных о банках', true);
        }
    }

    async function fetchCategoriesData() {
        try {
            const response = await fetch('/api/transactions/categories_stats', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            updateCategoriesCharts(data);
        } catch (error) {
            console.error('Error fetching categories data:', error);
            showToast('Ошибка при загрузке данных о категориях', true);
        }
    }

    // Toast notification function
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        if (!toast) return;

        toast.textContent = message;
        toast.style.backgroundColor = isError ? '#dc3545' : '#323232';
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function() {
          $("#navbar").load("navbar.html");
        });
    </script>

</div>
</body>
</html>